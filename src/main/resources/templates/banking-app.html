<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PO Bank - Complete Banking System</title>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0466c8 0%, #0353a4 100%);
        min-height: 100vh;
        color: #2C3E50;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .header {
        background: white;
        padding: 1rem 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0466c8;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .logout-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .page {
        display: none;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .page.active {
        display: block;
    }

    .page-header {
        background: linear-gradient(135deg, #0466c8 0%, #0353a4 100%);
        color: white;
        padding: 2rem;
        text-align: center;
    }

    .page-content {
        padding: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #2C3E50;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid #E9ECEF;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #0466c8;
        box-shadow: 0 0 0 3px rgba(4, 102, 200, 0.1);
    }

    .btn {
        padding: 0.875rem 2rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #0466c8;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #0353a4;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid;
    }

    .alert-success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .alert-info {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .btn.loading .loading-spinner {
        display: block;
    }

    .otp-inputs {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .otp-input {
        width: 50px;
        height: 50px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 600;
        border: 2px solid #E9ECEF;
        border-radius: 8px;
    }

    .document-upload {
        border: 2px dashed #E9ECEF;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .document-upload:hover {
        border-color: #0466c8;
        background: #f8f9fa;
    }

    .document-upload.uploaded {
        border-color: #28a745;
        border-style: solid;
        background: #f0fff4;
    }

    .uploaded-file {
        display: none;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .uploaded-file.show {
        display: flex;
    }

    .document-preview {
        max-width: 150px;
        max-height: 120px;
        border-radius: 8px;
        margin-top: 1rem;
        border: 1px solid #e9ecef;
        cursor: pointer;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .dashboard-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .dashboard-card h3 {
        margin-bottom: 1rem;
        color: #0466c8;
    }

    .customers-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .customers-table th,
    .customers-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .customers-table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-verified {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .kyc-documents {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .kyc-document {
        text-align: center;
    }

    .kyc-document img {
        max-width: 100%;
        max-height: 120px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }

    .hidden { display: none !important; }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .otp-inputs {
            gap: 0.5rem;
        }

        .otp-input {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }
    }
  </style>
</head>
<body>
<!-- Header -->
<div class="header" id="header" style="display: none;">
  <div class="logo">PO BANK</div>
  <div class="user-info">
    <span id="userDisplay"></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">
  <!-- Login Page -->
  <div class="page active" id="loginPage">
    <div class="page-header">
      <h1>Welcome to PO Bank</h1>
      <p>Secure Banking Made Simple</p>
    </div>
    <div class="page-content">
      <div class="alert alert-error hidden" id="loginError"></div>
      <div class="alert alert-success hidden" id="loginSuccess"></div>

      <!-- Customer Login -->
      <div id="customerLogin">
        <h3>Customer Login</h3>
        <div class="form-group">
          <label class="form-label">Mobile Number</label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="padding: 0.875rem; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px;">+91</span>
            <input type="tel" id="mobileNumber" class="form-input" placeholder="Enter 10-digit mobile number" maxlength="10">
          </div>
        </div>
        <button class="btn btn-primary" onclick="sendOtp()" id="sendOtpBtn" style="width: 100%;">
          <div class="loading-spinner" style="display: none;"></div>
          Send OTP
        </button>
      </div>

      <!-- OTP Verification -->
      <div id="otpVerification" class="hidden">
        <h3>Verify OTP</h3>
        <p>Enter the 6-digit OTP sent to your mobile number</p>
        <div class="otp-inputs">
          <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 0)">
          <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 1)">
          <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 2)">
          <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 3)">
          <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 4)">
          <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 5)">
        </div>
        <div style="display: flex; gap: 1rem;">
          <button class="btn btn-secondary" onclick="showCustomerLogin()" style="flex: 1;">Back</button>
          <button class="btn btn-primary" onclick="verifyOtp()" id="verifyOtpBtn" style="flex: 1;">
            <div class="loading-spinner" style="display: none;"></div>
            Verify OTP
          </button>
        </div>
      </div>

      <!-- Admin Login -->
      <div style="margin-top: 2rem; text-align: center;">
        <button class="btn btn-secondary" onclick="showAdminLogin()">Admin Login</button>
      </div>

      <div id="adminLogin" class="hidden" style="margin-top: 2rem;">
        <h3>Admin Login</h3>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" id="adminUsername" class="form-input" placeholder="Enter admin username">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password">
        </div>
        <div style="display: flex; gap: 1rem;">
          <button class="btn btn-secondary" onclick="showCustomerLogin()" style="flex: 1;">Back to Customer</button>
          <button class="btn btn-primary" onclick="adminLogin()" id="adminLoginBtn" style="flex: 1;">
            <div class="loading-spinner" style="display: none;"></div>
            Login
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Registration Page -->
  <div class="page" id="registrationPage">
    <div class="page-header">
      <h1>Customer Registration</h1>
      <p>Complete your profile to get started</p>
    </div>
    <div class="page-content">
      <div class="alert alert-error hidden" id="registrationError"></div>
      <div class="alert alert-success hidden" id="registrationSuccess"></div>

      <form id="registrationForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Full Name *</label>
            <input type="text" id="fullName" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email *</label>
            <input type="email" id="email" class="form-input" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Date of Birth</label>
            <input type="date" id="dob" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Phone Number *</label>
            <input type="tel" id="regPhone" class="form-input" readonly>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Address *</label>
          <textarea id="address" class="form-input" rows="3" required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">PAN Number *</label>
            <input type="text" id="pan" class="form-input" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" placeholder="ABCDE1234F" required>
          </div>
          <div class="form-group">
            <label class="form-label">Aadhaar Number *</label>
            <input type="text" id="aadhaar" class="form-input" pattern="[0-9]{12}" placeholder="123456789012" maxlength="12" required>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">
          <div class="loading-spinner" style="display: none;"></div>
          Register
        </button>
      </form>
    </div>
  </div>

  <!-- Customer Dashboard -->
  <div class="page" id="customerDashboard">
    <div class="page-header">
      <h1>Customer Dashboard</h1>
      <p>Manage your account and documents</p>
    </div>
    <div class="page-content">
      <div class="alert alert-info" id="kycStatusAlert">
        Your KYC status: <span id="kycStatusText">PENDING</span>
      </div>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>KYC Documents</h3>
          <p>Upload and manage your verification documents</p>
          <button class="btn btn-primary" onclick="showKycUpload()" style="margin-top: 1rem;">
            Upload Documents
          </button>
        </div>
        <div class="dashboard-card">
          <h3>Account Status</h3>
          <p>View your account verification status</p>
          <div id="accountStatus" style="margin-top: 1rem;">
            <span class="status-badge status-pending">Pending Verification</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KYC Upload Page -->
  <div class="page" id="kycUploadPage">
    <div class="page-header">
      <h1>KYC Document Upload</h1>
      <p>Upload clear images of your documents</p>
    </div>
    <div class="page-content">
      <div class="alert alert-error hidden" id="kycError"></div>
      <div class="alert alert-success hidden" id="kycSuccess"></div>

      <div class="alert alert-info">
        <strong>Requirements:</strong>
        <ul style="margin-top: 0.5rem; margin-left: 1rem;">
          <li>Clear, readable images</li>
          <li>All four corners visible</li>
          <li>No shadows or glare</li>
          <li>Max file size: 5MB</li>
          <li>Formats: JPG, PNG, PDF</li>
        </ul>
      </div>

      <!-- Document Upload Components -->
      <div class="document-upload" id="aadhaarUpload" onclick="triggerFileInput('aadhaar')">
        <input type="file" id="aadhaarFile" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" onchange="handleFileUpload(this, 'aadhaar')">
        <h4>📄 Aadhaar Card</h4>
        <p>Upload front side of your Aadhaar card</p>
        <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('aadhaar')">Choose File</button>
      </div>

      <div class="document-upload" id="panUpload" onclick="triggerFileInput('pan')">
        <input type="file" id="panFile" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" onchange="handleFileUpload(this, 'pan')">
        <h4>💳 PAN Card</h4>
        <p>Upload a clear copy of your PAN card</p>
        <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('pan')">Choose File</button>
      </div>

      <div class="document-upload" id="photoUpload" onclick="triggerFileInput('photo')">
        <input type="file" id="photoFile" accept=".jpg,.jpeg,.png" style="display: none;" onchange="handleFileUpload(this, 'photo')">
        <h4>📸 Photograph</h4>
        <p>Upload a recent passport-size photograph</p>
        <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('photo')">Choose File</button>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button class="btn btn-secondary" onclick="showCustomerDashboard()" style="flex: 1;">Back to Dashboard</button>
        <button class="btn btn-primary" onclick="reviewDocuments()" id="reviewBtn" disabled style="flex: 1;">Review Documents</button>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="page" id="adminDashboard">
    <div class="page-header">
      <h1>Admin Dashboard</h1>
      <p>Manage customers and KYC verifications</p>
    </div>
    <div class="page-content">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3 id="totalCustomers">0</h3>
          <p>Total Customers</p>
        </div>
        <div class="dashboard-card">
          <h3 id="pendingKyc">0</h3>
          <p>Pending KYC</p>
        </div>
        <div class="dashboard-card">
          <h3 id="verifiedKyc">0</h3>
          <p>Verified KYC</p>
        </div>
      </div>

      <h3>All Customers</h3>
      <div style="overflow-x: auto;">
        <table class="customers-table">
          <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>KYC Status</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="customersTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modals and JavaScript -->
<script th:src="@{/js/banking-app.js}"></script>
<script>
  // Global variables
let currentUser = null;
let authToken = null;
let currentCustomerId = null;
let otpSessionId = null;
let currentMobile = null;
let uploadedDocuments = {};
let currentModalCustomerId = null;

// API Base URLs - Updated to use relative paths for Spring Boot
const API_BASE = {
  gateway: '/api',
  customer: 'http://localhost:8081/api/customers' // Keep external for now
};

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
  checkExistingAuth();
  setupEventListeners();
});

function setupEventListeners() {
  // Mobile number validation
  const mobileInput = document.getElementById('mobileNumber');
  if (mobileInput) {
      mobileInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^\d]/g, '').substring(0, 10);
      });
  }

  // PAN formatting
  const panInput = document.getElementById('pan');
  if (panInput) {
      panInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.toUpperCase();
      });
  }

  // Aadhaar formatting
  const aadhaarInput = document.getElementById('aadhaar');
  if (aadhaarInput) {
      aadhaarInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^\d]/g, '').substring(0, 12);
      });
  }

  // Registration form
  const registrationForm = document.getElementById('registrationForm');
  if (registrationForm) {
      registrationForm.addEventListener('submit', function(e) {
          e.preventDefault();
          registerCustomer();
      });
  }

  // OTP inputs
  document.querySelectorAll('.otp-input').forEach(input => {
      input.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^\d]/g, '');
      });
  });
}

function checkExistingAuth() {
  const token = localStorage.getItem('authToken');
  const user = localStorage.getItem('currentUser');

  if (token && user) {
      authToken = token;
      currentUser = JSON.parse(user);
      showHeader();

      if (currentUser.role === 'ADMIN') {
          showAdminDashboard();
      } else {
          checkCustomerRegistration();
      }
  }
}

async function checkCustomerRegistration() {
  try {
      const response = await fetch(`${API_BASE.customer}/user/${currentUser.userId}/customer-id`, {
          headers: {
              'Authorization': `Bearer ${authToken}`
          }
      });

      if (response.ok) {
          const data = await response.json();
          currentCustomerId = data.customerId;
          showCustomerDashboard();
          loadCustomerStatus();
      } else {
          showRegistrationPage();
      }
  } catch (error) {
      console.error('Error checking customer registration:', error);
      showRegistrationPage();
  }
}

function showHeader() {
  const header = document.getElementById('header');
  if (header) {
      header.style.display = 'flex';
      const userDisplay = document.getElementById('userDisplay');
      if (userDisplay) {
          userDisplay.textContent =
              currentUser.role === 'ADMIN' ? `Admin: ${currentUser.username}` : `Customer: ${currentUser.username}`;
      }
  }
}

function hideHeader() {
  const header = document.getElementById('header');
  if (header) {
      header.style.display = 'none';
  }
}

// Authentication Functions
async function sendOtp() {
  const mobile = document.getElementById('mobileNumber').value.trim();

  if (!/^[6-9]\d{9}$/.test(mobile)) {
      showAlert('loginError', 'Please enter a valid 10-digit mobile number');
      return;
  }

  const btn = document.getElementById('sendOtpBtn');
  setLoadingState(btn, true);
  hideAlert('loginError');

  try {
      const response = await fetch(`${API_BASE.gateway}/auth/send-otp`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              phone: `+91${mobile}`
          })
      });

      const data = await response.json();

      if (response.ok) {
          otpSessionId = data.sessionId;
          currentMobile = mobile;
          showAlert('loginSuccess', 'OTP sent successfully! For demo, use 123456');
          showOtpVerification();
      } else {
          showAlert('loginError', data.error?.message || 'Failed to send OTP');
      }
  } catch (error) {
      console.error('Error sending OTP:', error);
      showAlert('loginError', 'Network error. Please try again.');
  } finally {
      setLoadingState(btn, false);
  }
}

async function verifyOtp() {
  const otpInputs = document.querySelectorAll('.otp-input');
  const otp = Array.from(otpInputs).map(input => input.value).join('');

  if (otp.length !== 6) {
      showAlert('loginError', 'Please enter complete 6-digit OTP');
      return;
  }

  const btn = document.getElementById('verifyOtpBtn');
  setLoadingState(btn, true);
  hideAlert('loginError');

  try {
      const response = await fetch(`${API_BASE.gateway}/auth/verify-otp`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              phone: `+91${currentMobile}`,
              otp: otp,
              sessionId: otpSessionId
          })
      });

      const data = await response.json();

      if (response.ok) {
          authToken = data.token;
          currentUser = {
              userId: data.userId,
              role: data.role,
              username: `customer_${currentMobile}`
          };

          localStorage.setItem('authToken', authToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));

          showHeader();
          showAlert('loginSuccess', 'Login successful!');

          setTimeout(() => {
              checkCustomerRegistration();
          }, 1000);
      } else {
          showAlert('loginError', data.error?.message || 'Invalid OTP');
      }
  } catch (error) {
      console.error('Error verifying OTP:', error);
      showAlert('loginError', 'Network error. Please try again.');
  } finally {
      setLoadingState(btn, false);
  }
}

async function adminLogin() {
  const username = document.getElementById('adminUsername').value.trim();
  const password = document.getElementById('adminPassword').value.trim();

  if (!username || !password) {
      showAlert('loginError', 'Please enter both username and password');
      return;
  }

  const btn = document.getElementById('adminLoginBtn');
  setLoadingState(btn, true);
  hideAlert('loginError');

  try {
      const response = await fetch(`${API_BASE.gateway}/auth/admin-login`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              username: username,
              password: password
          })
      });

      const data = await response.json();

      if (response.ok) {
          authToken = data.token;
          currentUser = {
              userId: data.userId,
              role: data.role,
              username: username
          };

          localStorage.setItem('authToken', authToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));

          showHeader();
          showAlert('loginSuccess', 'Admin login successful!');

          setTimeout(() => {
              showAdminDashboard();
          }, 1000);
      } else {
          showAlert('loginError', data.error?.message || 'Invalid credentials');
      }
  } catch (error) {
      console.error('Error in admin login:', error);
      showAlert('loginError', 'Network error. Please try again.');
  } finally {
      setLoadingState(btn, false);
  }
}

function logout() {
  localStorage.removeItem('authToken');
  localStorage.removeItem('currentUser');
  authToken = null;
  currentUser = null;
  currentCustomerId = null;
  uploadedDocuments = {};

  hideHeader();
  showLoginPage();
  clearAllForms();
}

// Customer Registration
async function registerCustomer() {
  const formData = {
      fullName: document.getElementById('fullName').value.trim(),
      email: document.getElementById('email').value.trim(),
      dob: document.getElementById('dob').value,
      phone: currentMobile,
      address: document.getElementById('address').value.trim(),
      pan: document.getElementById('pan').value.trim(),
      aadhaar: document.getElementById('aadhaar').value.trim()
  };

  // Validation
  if (!formData.fullName || !formData.email || !formData.address || !formData.pan || !formData.aadhaar) {
      showAlert('registrationError', 'Please fill all required fields');
      return;
  }

  const submitBtn = document.querySelector('#registrationForm button[type="submit"]');
  setLoadingState(submitBtn, true);
  hideAlert('registrationError');

  try {
      const response = await fetch(`${API_BASE.customer}/register`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (response.ok) {
          currentCustomerId = data.customerId;
          showAlert('registrationSuccess', 'Registration successful!');

          setTimeout(() => {
              showCustomerDashboard();
              loadCustomerStatus();
          }, 1500);
      } else {
          showAlert('registrationError', data.error?.message || 'Registration failed');
      }
  } catch (error) {
      console.error('Error registering customer:', error);
      showAlert('registrationError', 'Network error. Please try again.');
  } finally {
      setLoadingState(submitBtn, false);
  }
}

// Customer Dashboard Functions
async function loadCustomerStatus() {
  if (!currentCustomerId) return;

  try {
      const response = await fetch(`${API_BASE.customer}/${currentCustomerId}/status`, {
          headers: {
              'Authorization': `Bearer ${authToken}`
          }
      });

      if (response.ok) {
          const customer = await response.json();
          updateKycStatusDisplay(customer.kycStatus);
      }
  } catch (error) {
      console.error('Error loading customer status:', error);
  }
}

function updateKycStatusDisplay(status) {
  const statusText = document.getElementById('kycStatusText');
  const accountStatus = document.getElementById('accountStatus');

  if (statusText) statusText.textContent = status;

  let badgeClass = 'status-pending';
  let statusMessage = 'Pending Verification';

  if (status === 'VERIFIED') {
      badgeClass = 'status-verified';
      statusMessage = 'Verified';
  } else if (status === 'REJECTED') {
      badgeClass = 'status-rejected';
      statusMessage = 'Rejected';
  }

  if (accountStatus) {
      accountStatus.innerHTML = `<span class="status-badge ${badgeClass}">${statusMessage}</span>`;
  }
}

// Document Upload Functions
function triggerFileInput(docType) {
  const fileInput = document.getElementById(docType + 'File');
  if (fileInput) fileInput.click();
}

function handleFileUpload(input, docType) {
  const file = input.files[0];
  if (!file) return;

  // Validate file size (5MB limit)
  if (file.size > 5 * 1024 * 1024) {
      showAlert('kycError', 'File size should not exceed 5MB');
      input.value = '';
      return;
  }

  // Validate file type
  const allowedTypes = docType === 'photo'
      ? ['image/jpeg', 'image/jpg', 'image/png']
      : ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];

  if (!allowedTypes.includes(file.type)) {
      showAlert('kycError', 'Invalid file type. Please upload JPG, PNG or PDF files only.');
      input.value = '';
      return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
      uploadedDocuments[docType] = {
          file: file,
          base64: e.target.result,
          name: file.name,
          size: file.size,
          type: file.type
      };

      updateDocumentDisplay(docType, file, e.target.result);
      checkAllDocumentsUploaded();
      hideAlert('kycError');
  };

  reader.readAsDataURL(file);
}

function updateDocumentDisplay(docType, file, base64String) {
  const uploadDiv = document.getElementById(docType + 'Upload');
  if (uploadDiv) {
      uploadDiv.classList.add('uploaded');

      // Create file info display if it doesn't exist
      let fileInfo = document.getElementById(docType + 'FileInfo');
      if (!fileInfo) {
          fileInfo = document.createElement('div');
          fileInfo.id = docType + 'FileInfo';
          fileInfo.className = 'uploaded-file show';
          fileInfo.innerHTML = `
              <span>✅</span>
              <div>
                  <div id="${docType}FileName">${file.name}</div>
                  <div id="${docType}FileSize" style="font-size: 0.875rem; color: #6c757d;">${formatFileSize(file.size)}</div>
              </div>
              <button onclick="event.stopPropagation(); removeFile('${docType}')" style="background: none; border: none; color: #e74c3c; cursor: pointer;">×</button>
          `;
          uploadDiv.appendChild(fileInfo);
      } else {
          fileInfo.classList.add('show');
          document.getElementById(docType + 'FileName').textContent = file.name;
          document.getElementById(docType + 'FileSize').textContent = formatFileSize(file.size);
      }

      // Handle image preview
      if (file.type.startsWith('image/')) {
          let preview = document.getElementById(docType + 'Preview');
          if (!preview) {
              preview = document.createElement('img');
              preview.id = docType + 'Preview';
              preview.className = 'document-preview';
              preview.alt = docType + ' Preview';
              uploadDiv.appendChild(preview);
          }
          preview.src = base64String;
          preview.classList.remove('hidden');
          preview.onclick = () => openImageModal(base64String);
      }
  }
}

function removeFile(docType) {
  delete uploadedDocuments[docType];

  const input = document.getElementById(docType + 'File');
  if (input) input.value = '';

  const uploadDiv = document.getElementById(docType + 'Upload');
  if (uploadDiv) {
      uploadDiv.classList.remove('uploaded');

      const fileInfo = document.getElementById(docType + 'FileInfo');
      if (fileInfo) fileInfo.remove();

      const preview = document.getElementById(docType + 'Preview');
      if (preview) preview.remove();
  }

  checkAllDocumentsUploaded();
}

function checkAllDocumentsUploaded() {
  const requiredDocs = ['aadhaar', 'pan', 'photo'];
  const allUploaded = requiredDocs.every(doc => uploadedDocuments[doc]);

  const reviewBtn = document.getElementById('reviewBtn');
  if (reviewBtn) reviewBtn.disabled = !allUploaded;

  if (allUploaded) {
      showAlert('kycSuccess', 'All documents uploaded successfully!');
  }
}

function reviewDocuments() {
  // For demo purposes, show a simple confirmation
  if (confirm('Are you sure you want to submit your KYC documents?')) {
      submitKycDocuments();
  }
}

async function submitKycDocuments() {
  try {
      // For demo purposes, we'll simulate successful submission
      showAlert('kycSuccess', 'Documents submitted successfully! Your application will be reviewed within 24-48 hours.');

      setTimeout(() => {
          showCustomerDashboard();
          loadCustomerStatus();
      }, 2000);

  } catch (error) {
      console.error('Error submitting KYC documents:', error);
      showAlert('kycError', 'Failed to submit documents. Please try again.');
  }
}

// Admin Dashboard Functions
async function showAdminDashboard() {
  showPage('adminDashboard');
  await loadAllCustomers();
}

async function loadAllCustomers() {
  try {
      const response = await fetch(`${API_BASE.customer}/admin/all`, {
          headers: {
              'Authorization': `Bearer ${authToken}`
          }
      });

      if (response.ok) {
          const customers = await response.json();
          populateCustomersTable(customers);
          updateDashboardStats(customers);
      } else {
          console.error('Failed to load customers');
      }
  } catch (error) {
      console.error('Error loading customers:', error);
      // For demo, show placeholder data
      const placeholderCustomers = [
          {
              customerId: 1,
              fullName: 'John Doe',
              phone: '+919876543210',
              email: 'john@example.com',
              kycStatus: 'PENDING'
          }
      ];
      populateCustomersTable(placeholderCustomers);
      updateDashboardStats(placeholderCustomers);
  }
}

function populateCustomersTable(customers) {
  const tbody = document.getElementById('customersTableBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  customers.forEach(customer => {
      const row = document.createElement('tr');
      row.innerHTML = `
          <td>${customer.customerId}</td>
          <td>${customer.fullName}</td>
          <td>${customer.phone}</td>
          <td>${customer.email}</td>
          <td><span class="status-badge status-${customer.kycStatus.toLowerCase()}">${customer.kycStatus}</span></td>
          <td>
              <button class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;"
                      onclick="viewKycDocuments(${customer.customerId}, '${customer.fullName}')">
                  View KYC
              </button>
          </td>
      `;
      tbody.appendChild(row);
  });
}

function updateDashboardStats(customers) {
  const totalElement = document.getElementById('totalCustomers');
  const pendingElement = document.getElementById('pendingKyc');
  const verifiedElement = document.getElementById('verifiedKyc');

  if (totalElement) totalElement.textContent = customers.length;
  if (pendingElement) pendingElement.textContent = customers.filter(c => c.kycStatus === 'PENDING').length;
  if (verifiedElement) verifiedElement.textContent = customers.filter(c => c.kycStatus === 'VERIFIED').length;
}

function viewKycDocuments(customerId, customerName) {
  alert(`Viewing KYC documents for ${customerName} (ID: ${customerId})`);
}

// Navigation Functions
function showLoginPage() {
  showPage('loginPage');
  showCustomerLogin();
}

function showRegistrationPage() {
  showPage('registrationPage');
  const regPhone = document.getElementById('regPhone');
  if (regPhone && currentMobile) {
      regPhone.value = currentMobile;
  }
}

function showCustomerDashboard() {
  showPage('customerDashboard');
}

function showKycUpload() {
  showPage('kycUploadPage');
}

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(page => {
      page.classList.remove('active');
  });
  const targetPage = document.getElementById(pageId);
  if (targetPage) {
      targetPage.classList.add('active');
  }
}

function showCustomerLogin() {
  const customerLogin = document.getElementById('customerLogin');
  const otpVerification = document.getElementById('otpVerification');
  const adminLogin = document.getElementById('adminLogin');

  if (customerLogin) customerLogin.classList.remove('hidden');
  if (otpVerification) otpVerification.classList.add('hidden');
  if (adminLogin) adminLogin.classList.add('hidden');
}

function showOtpVerification() {
  const customerLogin = document.getElementById('customerLogin');
  const otpVerification = document.getElementById('otpVerification');
  const adminLogin = document.getElementById('adminLogin');

  if (customerLogin) customerLogin.classList.add('hidden');
  if (otpVerification) otpVerification.classList.remove('hidden');
  if (adminLogin) adminLogin.classList.add('hidden');

  const firstOtpInput = document.querySelector('.otp-input');
  if (firstOtpInput) firstOtpInput.focus();
}

function showAdminLogin() {
  const customerLogin = document.getElementById('customerLogin');
  const otpVerification = document.getElementById('otpVerification');
  const adminLogin = document.getElementById('adminLogin');

  if (customerLogin) customerLogin.classList.add('hidden');
  if (otpVerification) otpVerification.classList.add('hidden');
  if (adminLogin) adminLogin.classList.remove('hidden');
}

// Modal Functions
function openImageModal(imageSrc) {
  // For demo purposes, open in new tab
  window.open(imageSrc, '_blank');
}

// Utility Functions
function showAlert(alertId, message) {
  const alert = document.getElementById(alertId);
  if (alert) {
      alert.textContent = message;
      alert.classList.remove('hidden');

      // Auto-hide success messages
      if (alertId.includes('Success')) {
          setTimeout(() => {
              alert.classList.add('hidden');
          }, 5000);
      }
  }
}

function hideAlert(alertId) {
  const alert = document.getElementById(alertId);
  if (alert) {
      alert.classList.add('hidden');
  }
}

function setLoadingState(button, loading) {
  if (!button) return;

  const spinner = button.querySelector('.loading-spinner');
  if (loading) {
      if (spinner) spinner.style.display = 'block';
      button.disabled = true;
  } else {
      if (spinner) spinner.style.display = 'none';
      button.disabled = false;
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function moveToNext(current, index) {
  if (current.value.length === 1 && index < 5) {
      const otpInputs = document.querySelectorAll('.otp-input');
      if (otpInputs[index + 1]) {
          otpInputs[index + 1].focus();
      }
  }

  // Auto-verify when all 6 digits are entered
  const otpInputs = document.querySelectorAll('.otp-input');
  const otp = Array.from(otpInputs).map(input => input.value).join('');
  if (otp.length === 6) {
      setTimeout(() => {
          verifyOtp();
      }, 500);
  }
}

function clearAllForms() {
  // Clear login forms
  const mobileNumber = document.getElementById('mobileNumber');
  const adminUsername = document.getElementById('adminUsername');
  const adminPassword = document.getElementById('adminPassword');

  if (mobileNumber) mobileNumber.value = '';
  if (adminUsername) adminUsername.value = '';
  if (adminPassword) adminPassword.value = '';

  document.querySelectorAll('.otp-input').forEach(input => input.value = '');

  // Clear registration form
  const registrationForm = document.getElementById('registrationForm');
  if (registrationForm) registrationForm.reset();

  // Clear uploaded documents
  uploadedDocuments = {};
  document.querySelectorAll('.document-upload').forEach(upload => {
      upload.classList.remove('uploaded');
  });

  // Hide all alerts
  document.querySelectorAll('.alert').forEach(alert => {
      alert.classList.add('hidden');
  });
}
</script>
</body>
</html>